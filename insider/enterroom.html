<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="index.css">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <script type="text/javascript" src="settings.js"></script>

    <script>
        osql.requireLogin();

        windows.onload = function () {
            var username = sessionStrage.getItem('usename')
            document.getElementById('name') = username;
        }



        var room = sessionStorage.getItem('userid');
        //ルーム作成が押されたら
        document.getElementByID('roombutton').addEventListener('click', async function makeRoom() {
            //ルーム番号を生成
            var array = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
            var n1 = array[Math.floor(Math.random() * array.length)];
            var n2 = array[Math.floor(Math.random() * array.length)];
            var n3 = array[Math.floor(Math.random() * array.length)];
            var room = n1 + n2 + n3;
            //データベース登録
            var sql = `insert into Rooms (id, num, state, theme) values("${room}", "1", "受付中", "null");`;
            var objects = await osql.connect(sql);
            console.log(objects);
            //画面遷移情報更新
            var sql = `insert into Pages (room, start, go) values("${room}", "null", "null");`;
            var objects = await osql.connect(sql);
            console.log(objects);
            //セッションストレージに入れる
            sessionStorage.setItem('room', room);
            sessionStorage.setItem('leader', 'yes');
            //ページを４主催者用へ
            location.href = 'index_4.html';
        })
        //入室が押されたら
        document.getElementByID('enter').addEventListener('click', async function enterRoom() {
            var roomNum = document.getElementById('roomNum').value;

            var sql = `select * from Rooms where id="${roomNum}";`;
            var objects = await osql.connect(sql);
            console.log(objects);

            if (objects !== null && object[0].state == "受付中") {
                //ルーム番号roomNumをセッションストレージに入れる
                sessionStorage.setItem('room', roomNum);
                sessionStorage.setItem('leader', 'no');
                //役割情報にメンバーと部屋名を入れる
                var sql = `insert into Roles (userid, role, roomid) values("${userid}", "null", "${room}");`;
                var objects = await osql.connect(sql);
                console.log(objects);
                //データベース更新
                var sql = `update Rooms set num="${objects[0]['num'] + 1}"`;
                var objects = await osql.connect(sql);
                console.log(objects);
                //ページを４その他の人用に遷移
                location.href = 'member.html';
            } else {
                //エラー表示
                window.alert('ルームが存在しないか、受付終了しています')
            }
        })
    </script>

</head>

<body>
    <p class="title">インサイダーゲーム</p>
    <p>ようこそ<span id=name>xx</span>さん</p>
    <p>ルームを作成</p>
    <input type="button" id="roombutton" value="作成">
    <p>ルーム入室</p>
    <input type="text" id="roomNum" placeholder="ルーム番号">
    <input type="button" id="enter" value="入室">
</body>

</html>