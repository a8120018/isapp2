<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="index.css">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <script type="text/javascript" src="settings.js"></script>



</head>

<body>
    <p class="title">インサイダーゲーム</p>
    <p>ようこそ<span id=name>xx</span>さん</p>
    <p>ルームを作成</p>
    <input type="button" id="roombutton" value="作成">
    <p>ルーム入室</p>
    <input type="text" id="roomNum" placeholder="ルーム番号">
    <input type="button" id="enter" value="入室">


    <script>
        osql.requireLogin();

        //window.onload = function () {
        var username = sessionStorage.getItem('username')
        var userid = sessionStorage.getItem('userid')
        document.getElementById('name').innerHTML = username;
        sessionStorage.setItem('userid', userid);
        sessionStorage.setItem('username', username);
        //}



        var room = sessionStorage.getItem('userid');
        //ルーム作成が押されたら
        document.getElementById('roombutton').addEventListener('click', async function makeRoom() {
            //ルーム番号を生成
            var array = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
            var n1 = array[Math.floor(Math.random() * array.length)];
            var n2 = array[Math.floor(Math.random() * array.length)];
            var n3 = array[Math.floor(Math.random() * array.length)];
            var room = n1 + n2 + n3 + n1 + n2 + n3;
            console.log(room)
            //データベース登録
            var sql = `insert into Rooms (id, roomnum, state, themenum, start, go) values("${room}", "1", "受付中", "0", "null", "null");`;
            var objects = await osql.connect(sql);
            console.log(objects);
            //セッションストレージに入れる
            sessionStorage.setItem('room', room);
            sessionStorage.setItem('leader', 'yes');
            //ページを４主催者用へ
            location.href = 'member.html';
        })
        //入室が押されたら
        document.getElementById('enter').addEventListener('click', async function enterRoom() {
            var roomNum = document.getElementById('roomNum').value;

            var sql = `select * from Rooms where id="${roomNum}";`;
            var objects = await osql.connect(sql);
            console.log(objects);
            var membernum = objects[0]['roomnum']
            console.log(membernum);

            if (objects !== null && objects[0].state == "受付中") {
                //ルーム番号roomNumをセッションストレージに入れる
                sessionStorage.setItem('room', roomNum);
                sessionStorage.setItem('leader', 'no');
                //役割情報にメンバーと部屋名を入れる
                console.log(roomNum);
                // console.log(userid);
                var sql = `insert into Points (userid, roomid, role, guesstheme, point1, selectinsider, point2) values("${userid}", "${roomNum}", "null", "null", "0", "null", "0");`;
                var objects = await osql.connect(sql);
                console.log(objects);
                //データベース更新
                var sql = `update Rooms set roomnum="${Number(membernum) + 1}"`;
                var objects = await osql.connect(sql);
                console.log(objects);
                //ページを４その他の人用に遷移
                location.href = 'member.html';
            } else {
                //エラー表示
                window.alert('ルームが存在しないか、受付終了しています')
            }
        })
    </script>
</body>

</html>