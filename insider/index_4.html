<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <script type="text/javascript" src="settings.js"></script>

    <script>
        osql.requireLogin();
        //ルーム番号を表示
        var room = sessionStorage.getItem('room');
        document.getElementById('room').innerHTML = room;
        //ルーム作成者か
        var leader = sessionStorage.getItem('leader');

        if (leader == 'yes') {
            document.getElementById('button').innerHTML = '<input type="button" id="start" value="始める">';
        }
        //1秒ごとにメンバー取得
        let countupVal, updateVal;
        let count = 0;
        let countup = async function () {
            count = count + 1;
            console.log(count)
            var html = '<table id="table1"><tr>';

            var sql = `select * from Users left join (select * from Roles where id="${room}") as Members on Roles.userid = Members.ID ;`;
            var objects = await osql.connect(sql);
            console.log(objects);

            var member = [];
            for (var i = 0; i < objects.length; i++) {
                member.push(objects[i]['ID']);//あってるかわかんない
                html = html + `<td>${objects[i]['nickname']}</td>`;
            }
            document.getElementById('table1').innerHTML = html;

            //画面遷移がOKになってたら画面遷移する
            var sql2 = `select start from Pages where room="${room}";`;
            var objects2 = await osql.connect(sql2);
            console.log(objects2);
            if (objects2[0]['start'] == "OK") {
                location.href = 'index_5.html';
            }


        }
        countupVal = setInterval(countup, 1000);

        document.getElementById('start').addEventListener('click', async function startGame() {
            //ルーム受付中を受付終了に更新
            var sql = `update Rooms set state = "受付終了"`;
            var objects = await osql.connect(sql);
            console.log(objects);
            //役割決め
            //配列シャッフル関数
            const shuffle = ([...array]) => {
                for (let i = array.length - 1; i >= 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            //
            const array = ['インサイダー', 'ゲームマスター']
            //人数を取ってくる
            var sql = `select num from Rooms where id="${room}";`;
            var objects = await osql.connect(sql);
            console.log(objects);
            //n-2人分の庶民を配列に追加
            for (var i = 0; i < objects[0]['num'] - 2; i++) {
                array.push("庶民")
            }
            //配列が完成　シャッフルする
            shuffle(array);
            //メンバーと、役割の配列　インデックスが同じのを役割とする
            for (var i = 0; i < objects[0]['num']; i++) {
                member[i]
                var sql = `update Roles set role = "${array[i]}" where roomid="${room}" and where userid="${member[i]}"`;
                var objects = await osql.connect(sql);
                console.log(objects);
            }

            //お題決め
            var max = 100;
            var random = Math.floor(Math.random() * (max + 1));
            var sql = `update Rooms set theme = "${random}" where id="${room}"`;
            var objects = await osql.connect(sql);
            console.log(objects);
            //画面遷移更新
            var sql = `update Pages set start = "OK" where room="${room}"`;
            var objects = await osql.connect(sql);
            console.log(objects);
            //画面遷移
            location.href = 'index_5.html';
        })






    </script>
</head>

<body>
    <p class="title">インサイダーゲーム</p>
    <p>ルーム：
    <div class="room"></div>
    </p>
    <p>参加者：</p>
    <div id="table1"></div>
    <div id="button"></div>

</body>

</html>